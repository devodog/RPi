<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sensor & Valve Dashboard</title>
<style>
  /* Reset & base */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9faff;
    color: #222;
    margin: 0;
    padding: 20px;
  }
  h1, h2 {
    color: #333;
  }
  h1 {
    text-align: center;
    margin-bottom: 40px;
  }
  /* Container */
  .container {
    max-width: 900px;
    margin: 0 auto;
  }
  /* Section styling */
  section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 8px 20px rgb(0 0 0 / 0.1);
    padding: 25px 30px;
    margin-bottom: 40px;
  }
  section h2 {
    border-bottom: 2px solid #0078d4;
    padding-bottom: 8px;
    margin-bottom: 20px;
  }
  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  th, td {
    padding: 12px 15px;
    border-bottom: 1px solid #ddd;
    text-align: left;
    font-size: 15px;
  }
  th {
    background-color: #0078d4;
    color: white;
  }
  tr:hover {
    background-color: #f1f7ff;
  }
  /* Status badges */
  .status {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: 600;
    color: white;
    font-size: 14px;
  }
  .status.open {
    background-color: #28a745;
  }
  .status.closed {
    background-color: #dc3545;
  }
  /* Responsive */
  @media (max-width: 600px) {
    th, td {
      padding: 8px 10px;
      font-size: 13px;
    }
  }

  /* Vertical bar container */
  .vertical-bar {
    width: 40px;
    height: 150px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #eee;
    position: relative;
    margin: 10px auto;
  }

  /* Filled portion */
  .vertical-bar-fill {
    position: absolute;
    bottom: 0;
    width: 100%;
    border-radius: 6px 6px 0 0;
    transition: height 0.5s ease, background-color 0.5s ease;
  }

  /* Container for sensor with label */
  .sensor-bar-container {
    text-align: center;
    margin-bottom: 30px;
  }

  .sensor-label {
    margin-bottom: 6px;
    font-weight: 600;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Sensor & Valve Dashboard</h1>

  <section id="sensors">
    <h2>Sensors</h2>
    <!-- Sensor data tables will be injected here -->
  </section>

  <section id="valves">
    <h2>Valves</h2>
    <!-- Valve data tables will be injected here -->
  </section>
</div>

<script>
async function fetchData() {
  try {
    const res = await fetch('/status_json');
    if (!res.ok) throw new Error('Network response was not OK');
    const jsonData = await res.json();

    updateDashboard(jsonData);

  } catch (err) {
    console.error('Failed to fetch data:', err);
  }
}

// Map bits array to percentage level
function levelFromBits(bits) {
  const sum = bits.reduce((a,b) => a + b, 0);

  switch(sum) {
    case 0: return 100;
    case 1: return 75;
    case 2: return 50;
    case 3: return 25;
    case 4: return 0;
    default: return 0;
  }
}

// Map percentage to color
function colorFromLevel(percent) {
  switch(percent) {
    case 100: return '#28a745'; // green
    case 75: return '#ffc107';  // yellow
    case 50: return '#fd7e14';  // orange
    case 25: return '#dc3545';  // red
    case 0: return '#000000';   // black
    default: return '#0078d4';  // fallback blue
  }
}

// Create the vertical bar element given bits
function createVerticalBar(bits) {
  const percent = levelFromBits(bits);
  const color = colorFromLevel(percent);

  const container = document.createElement('div');
  container.className = 'sensor-bar-container';

  const label = document.createElement('div');
  label.className = 'sensor-label';
  label.textContent = `${percent}% level`;
  container.appendChild(label);

  const bar = document.createElement('div');
  bar.className = 'vertical-bar';

  const fill = document.createElement('div');
  fill.className = 'vertical-bar-fill';
  fill.style.height = percent + '%';
  fill.style.backgroundColor = color;

  bar.appendChild(fill);
  container.appendChild(bar);

  return container;
}

function createTableFromObject(dataObj) {
  const table = document.createElement('table');
  const tbody = document.createElement('tbody');
  for (const [key, value] of Object.entries(dataObj)) {
    if (key === "Top" || key === "Upper Mid" || key === "Lower Mid" || key === "Bottom Mid") {
      // Skip these keys because we show the bar instead
      continue;
    }

    const tr = document.createElement('tr');
    const tdKey = document.createElement('td');
    tdKey.textContent = key;
    const tdVal = document.createElement('td');

    if (key.toLowerCase() === 'status') {
      const span = document.createElement('span');
      span.classList.add('status');
      if (value === "open" || value === true || value === "true") {
        span.textContent = "Open";
        span.classList.add('open');
      } else {
        span.textContent = "Closed";
        span.classList.add('closed');
      }
      tdVal.appendChild(span);
    } else {
      tdVal.textContent = value;
    }

    tr.appendChild(tdKey);
    tr.appendChild(tdVal);
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  return table;
}

function updateDashboard(data) {
  const sensorsSection = document.getElementById('sensors');
  const valvesSection = document.getElementById('valves');

  // Clear old data
  sensorsSection.innerHTML = '<h2>Sensors</h2>';
  valvesSection.innerHTML = '<h2>Valves</h2>';

  // Render Sensors with vertical bars for level
  data.Sensors.forEach(sensorObj => {
    for (const [sensorName, sensorData] of Object.entries(sensorObj)) {
      const heading = document.createElement('h3');
      heading.textContent = sensorName;
      sensorsSection.appendChild(heading);
      console.log(sensorData);
      // Get bits for level
      const bits = [
        sensorData['Top'] ? 1 : 0,
        sensorData['Upper Mid'] ? 1 : 0,
        sensorData['Lower Mid'] ? 1 : 0,
        sensorData['Bottom Mid'] ? 1 : 0,
      ];

      // Create and append vertical bar
      const bar = createVerticalBar(bits);
      sensorsSection.appendChild(bar);

      // Show rest of sensor data (excluding level bits)
      const table = createTableFromObject(sensorData);
      sensorsSection.appendChild(table);
    }
  });

  // Render Valves normally as tables
  data.Valves.forEach(valveObj => {
    for (const [valveName, valveData] of Object.entries(valveObj)) {
      const heading = document.createElement('h3');
      heading.textContent = valveName;
      valvesSection.appendChild(heading);

      const table = createTableFromObject(valveData);
      valvesSection.appendChild(table);
    }
  });
}

// Fetch data immediately on page load
fetchData();

// Refresh every 5 seconds
setInterval(fetchData, 5000);
</script>

</body>
</html>
